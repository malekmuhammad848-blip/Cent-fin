workflows:
  native-android-project:
    name: Android ZIP Project Workflow
    max_build_duration: 60
    instance_type: mac_mini_m1
    environment:
      vars:
        JAVA_VERSION: "17"
      node: "18"
    scripts:
      - name: Extract project ZIP
        script: |
          ZIP_FILE=$(find . -name "*.zip" -print -quit)
          if [ -z "$ZIP_FILE" ]; then
            echo "No ZIP file found in the repository."
            exit 1
          fi
          echo "Extracting $ZIP_FILE..."
          unzip -o "$ZIP_FILE" -d .
      - name: Locate gradlew and set permissions
        script: |
          # البحث عن gradlew في أي مكان
          GRADLEW_PATH=$(find . -name gradlew -type f -print -quit)
          if [ -z "$GRADLEW_PATH" ]; then
            echo "Error: gradlew not found even after extraction."
            exit 1
          fi
          echo "Found gradlew at: $GRADLEW_PATH"
          # استخراج مجلد gradlew والتعامل مع الفراغات في المسار
          PROJECT_ROOT=$(dirname "$GRADLEW_PATH")
          echo "Project root: $PROJECT_ROOT"
          cd "$PROJECT_ROOT"
          chmod +x ./gradlew
      - name: Install Node.js dependencies
        script: |
          if [ -f package.json ]; then
            echo "Installing npm dependencies..."
            npm install
          else
            echo "No package.json found, skipping npm install"
          fi
      - name: Sync Capacitor
        script: |
          if [ -f package.json ]; then
            echo "Running Capacitor sync..."
            npx cap sync android
          else
            echo "No Capacitor project, skipping sync"
          fi
      - name: Build Android Release APK
        script: |
          echo "Building APK..."
          # استخدام مسار كامل للgradlew مع اقتباسات
          ./gradlew assembleRelease
    artifacts:
      - "**/build/outputs/apk/release/*.apk"
