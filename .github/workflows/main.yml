name: Build & Sign Android APK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64

    steps:
      - uses: actions/checkout@v4

      # Setup Node.js 20
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Debug: تحقق من وجود package.json في www
      - name: Check www folder
        run: |
          cd Smartcent_Ready/www
          ls -la
          node -v
          npm -v

      # Install npm dependencies في www
      - name: Install npm packages
        run: |
          cd Smartcent_Ready/www
          npm install --legacy-peer-deps

      # Build Web Assets من www
      - name: Build Web Assets
        run: |
          cd Smartcent_Ready/www
          npx vite build --outDir ../android/app/src/main/assets/public

      # Capacitor sync
      - name: Capacitor Sync Android
        run: |
          cd Smartcent_Ready
          npx cap sync android

      # Prepare Gradle
      - name: Prepare Gradle
        run: |
          cd Smartcent_Ready/android
          chmod +x gradlew

      # Create Signing Keystore
      - name: Create Signing Keystore
        run: |
          cd Smartcent_Ready/android
          keytool -genkey -v -keystore release.keystore -alias releasekey \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -storepass 123456 -keypass 123456 \
            -dname "CN=App, OU=Dev, O=YourCompany, L=City, S=State, C=US"

      # Configure Signing
      - name: Configure Signing
        run: |
          cd Smartcent_Ready/android
          echo "RELEASE_STORE_FILE=release.keystore" >> gradle.properties
          echo "RELEASE_KEY_ALIAS=releasekey" >> gradle.properties
          echo "RELEASE_STORE_PASSWORD=123456" >> gradle.properties
          echo "RELEASE_KEY_PASSWORD=123456" >> gradle.properties

      # Build Signed Release APK
      - name: Build APK
        run: |
          cd Smartcent_Ready/android
          ./gradlew assembleRelease

      # Upload APK artifact
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: Smartcent_Ready/android/app/build/outputs/apk/release/*.apk
