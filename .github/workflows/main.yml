name: Build & Sign Android APK

on:
  workflow_dispatch:

jobs:
  build-and-sign-apk:
    runs-on: ubuntu-latest
    env:
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64

    steps:
      # 1ï¸âƒ£ Checkout repository
      - uses: actions/checkout@v4

      # 2ï¸âƒ£ Setup Node 20
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3ï¸âƒ£ Debug Node & npm
      - name: Check Node and npm
        shell: bash
        run: |
          cd Smartcent_Ready
          node -v
          npm -v
          ls -la
          pwd

      # 4ï¸âƒ£ Install npm dependencies
      - name: Install npm packages
        shell: bash
        run: |
          cd Smartcent_Ready
          npm install --legacy-peer-deps

      # 5ï¸âƒ£ Build React/Vite Web Assets
      - name: Build Web Assets
        shell: bash
        run: |
          cd Smartcent_Ready
          npm run build

      # 6ï¸âƒ£ Capacitor sync Android
      - name: Capacitor Sync
        shell: bash
        run: |
          cd Smartcent_Ready
          npx cap sync android

      # 7ï¸âƒ£ Set Gradle permissions
      - name: Prepare Gradle
        shell: bash
        run: |
          cd Smartcent_Ready/android
          chmod +x gradlew

      # 8ï¸âƒ£ Create temporary signing keystore
      - name: Create Signing Keystore
        shell: bash
        run: |
          cd Smartcent_Ready/android
          keytool -genkey -v -keystore release.keystore -alias releasekey \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -storepass 123456 -keypass 123456 \
            -dname "CN=App, OU=Dev, O=YourCompany, L=City, S=State, C=US"

      # 9ï¸âƒ£ Configure signing in gradle.properties
      - name: Configure Signing
        shell: bash
        run: |
          cd Smartcent_Ready/android
          echo "RELEASE_STORE_FILE=release.keystore" >> gradle.properties
          echo "RELEASE_KEY_ALIAS=releasekey" >> gradle.properties
          echo "RELEASE_STORE_PASSWORD=123456" >> gradle.properties
          echo "RELEASE_KEY_PASSWORD=123456" >> gradle.properties

      # ğŸ”Ÿ Build Signed Release APK
      - name: Build APK
        shell: bash
        run: |
          cd Smartcent_Ready/android
          ./gradlew assembleRelease

      # 1ï¸âƒ£1ï¸âƒ£ Upload APK artifact
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: Smartcent_Ready/android/app/build/outputs/apk/release/*.apk
